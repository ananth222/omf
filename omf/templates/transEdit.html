<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Network #{{ networkNum }} from {{ modelName }}</title>
	<script type="text/javascript" src="/static/svg-pan-zoom.js"></script>
	<script type="text/javascript" src="/static/omf.js"></script>
	<script type="text/javascript" src="/static/jquery-1.9.1.js"></script>
	<script type="text/javascript" src="/static/jquery-ui.min.js"></script>
	<link rel="stylesheet" href="/static/omf.css"/>
	<link rel="shortcut icon" href="/static/favicon.ico"/>
	<style>
		* { font-family: Helvetica, Arial, Sans-Serif;}
		div.divButton {
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
			cursor: pointer;
			cursor: hand;
			position:fixed;
			width:30px;
			height:30px;
			text-align:center;
			font-size:30px;
			line-height:30px;
			color:white;
		}
		div#tableScroller {
			overflow-y: auto;
			overflow-x: hidden;
			position: fixed;
			width: 315px;
			top: 55px;
			right: 5px;
			max-height:90%;
		}
		table {
			width: 300px;
			border:1px solid black;
			border-collapse: collapse;
			text-align: left;
			table-layout:fixed;
		}
		body {margin:0px;}
		td {
			background:white;
			color:black;
			word-wrap:break-word;
		}
		th {
			background:black;
			color:white;
		}
		svg {
			position: absolute;
			left: 0%;
			top: 0%;
			width: 100%;
			height: 100%;
			z-index: -1;
		}
		#saveButton {
			float:right;
		}
		input[type='submit'] {padding:4px 6px 4px; float:right;}
		input {
			width:140px;
		}
		/* Load Spinner */
		.loader {
			margin: 60px auto;
			font-size: 10px;
			position: relative;
			text-indent: -9999em;
			border-top: 1.1em solid rgba(255, 255, 255, 0.2);
			border-right: 1.1em solid rgba(255, 255, 255, 0.2);
			border-bottom: 1.1em solid rgba(255, 255, 255, 0.2);
			border-left: 1.1em solid #ffffff;
			-webkit-transform: translateZ(0);
			-ms-transform: translateZ(0);
			transform: translateZ(0);
			-webkit-animation: load8 1.1s infinite linear;
			animation: load8 1.1s infinite linear;
		}
		.loader,
		.loader:after {
			border-radius: 50%;
			width: 10em;
			height: 10em;
		}
		@-webkit-keyframes load8 {
			0% {
			-webkit-transform: rotate(0deg);
			transform: rotate(0deg);
			}
			100% {
			-webkit-transform: rotate(360deg);
			transform: rotate(360deg);
			}
		}
		@keyframes load8 {
			0% {
			-webkit-transform: rotate(0deg);
			transform: rotate(0deg);
			}
			100% {
			-webkit-transform: rotate(360deg);
			transform: rotate(360deg);
			}
		}
		table.importOptions {font-size:10pt;width:100%; text-align:left; margin-left:5px;display:inline;border:none;background:transparent;color:black;}
		table.importOptions tr td th {text-align:left;width:40%;border:none;background:transparent;color:black;}
	</style>
	<script>networkData={% if networkData %}{{networkData | safe}}{% else %}null{% endif %}</script>
</head>
<body onkeypress='hotkeys()' onload="loading();" style='width:100%;height:100%'>
	<!-- Start Controls -->
	<div style='background:dimgray; top:55px; left:5px' class='divButton' onclick='window.panZoom.zoomIn()' title='Zoom In'>+</div>
	<div style='background:dimgray; top:95px; left:5px' class='divButton' onclick='window.panZoom.zoomOut()' title='Zoom Out'>-</div>
	<div style='background:dimgray; top:135px; left:5px' class='divButton' onclick='window.panZoom.reset()' title='Reset Zoom'>R</div>
	<div style='background:dimgray; top:175px; left:5px;' class='divButton' onclick='scaleTo()' title='Zoom To'>S</div>
	<!-- End Controls -->
	<svg id='svgContainer' xmlns='http://www.w3.org/2000/svg' style='width:100%;height:100%;min-width:1000px;background-color:white;' onclick='svgClick(event)' onmousedown='mouseDown(event)' onmouseup='mouseUp(event)'>
		<style type="text/css">
			<![CDATA[
			line {stroke:black;}
			line.parentChild {stroke:LightGrey;}
			circle {stroke:white; fill:gray;}
			rect {stroke:white; fill:DarkGrey;}
			line.selected, circle.selected, rect.selected {stroke:lime;}
			]]>
		</style>
	</svg>
	<!-- Menu Bar: ADD -->
	<div id="header">
		<div id="menuLeft" style="margin-top:-5px"> <!--HACK: override padding from header.-->
			&nbsp;<span contenteditable="false" id='networkName' name='networkName' style="font-weight:bold;">{{ networkName }}</span>
			<br>
			&nbsp;from&#8220;<span id = 'modelNameHeader'>{{ modelName }}</span>&#8221;
		</div>
		<div id="menuRight">
			<div id="editDiv" style="display:inline-block">
				<div class="buttonGroup">
					<button id="editOps" class='pill' onclick='dropPill(this, "Edit");'>Edit ▾</button>
					<ul class='menu right' style="display:none">
						<li><a href='javascript:showModal("anonymizeModal");'>Anonymization...</a></li>
						<li><a href='javascript:showModal("findModal");'>Find...</a></li>

					</ul>
				</div>
			</div>
			<div id="addDiv" style="display:inline-block">
				<div class="buttonGroup">
					<button id="addOps" class='pill' onclick='dropPill(this, "Add");'>Add ▾</button>
					<ul id='newObjectMenu' class='menu right' style="display:none">
						<li><a href='javascript:newNode("bus");'>Bus</a></li>
						<li><a href='javascript:newLink();'>Line</a></li>
						<li><a href='javascript:newGen();'>Generator</a></li>
					</ul>
				</div>
			</div>
			<div id="fileDiv" style="display:inline-block">
				<div class='buttonGroup'>
					{% if is_admin or not public %}
					<button id="fileOps" class='pill' onclick='dropPill(this, "File")'>File ▾</button>
					<ul class='menu right' style="display:none">
						<li><a href='javascript:saveNetwork();'>Save</a></li>
						<li><a href='javascript:renameNetwork();'>Rename</a></li>
						<li><a href='javascript:showModal("blankNetworkModal");'>New Blank Network...</a></li>
						<li><a href='javascript:showModal("matpowerModal");'>MATPOWER Import...</a></li>
						<li><a href='javascript:showModal("rawModal");'>RAW Import...</a></li>
						<li><a href='javascript:downloadTextFile("networkData.omt", JSON.stringify(networkData, null, 2));'>Download .omt File</a></li>
					</ul>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
	<div id='blankNetworkModal' class= 'modal'>
		<div class="modalContent" id='blankModal'>
			<form onsubmit='event.preventDefault(); return startConversion("networkNameNew",1);' action='/newBlankNetwork/{{ owner }}' id='newnetwork' enctype='multipart/form-data' method='post'>
				<input type="hidden" id="networkNum" name="networkNum" value="{{ networkNum }}" />
				<input type="hidden" id="modelName" name="modelName" value="{{ modelName }}" />
				<table class='importOptions'>
				<th style="background:transparent;color:black;">Blank Network</th>
					<tr>
						<td>Name</td>
						<td><input type='text' id='networkNameNew' name='networkNameNew' required/></td>
					</tr>
					<tr>
						<td><a id='modalCancel' href="#" onclick='closeModal("blankNetworkModal")' style="text-align:center;font-size:10pt;">Cancel</a></td>
						<td><input type='submit' value='Create' style='min-width:45px;'/></td>
					</tr>
				</table>
			</form>
		</div>
	</div>
	<div id="matpowerModal" class= 'modal'>
		<div class="modalContent" id='matModal' style='width:350px;'>
			<form onsubmit='startConversion("networkNameM", "matpower", 2); return false;' action="/matpowerImport/{{ owner }}" id='matpower' enctype='multipart/form-data' method='post'>
				<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}" />
				<input type="hidden" id="networkNum" name="networkNum" value="{{ networkNum }}" />
				<input type="hidden" id="modelName" name="modelName" value="{{ modelName }}" />
				<table class='importOptions'>
				<th style="background:transparent;color:black;">MATPOWER Conversion</th>
					<tr>
						<td>Name</td>
						<td><input type='text' id='networkNameM' name='networkNameM' required/></td>
					</tr>
					<tr>
						<td>Data File (.m)</td>
						<td><input type='file' name='matFile' accept = '.m' required/></td>
					</tr>
					<tr>
						<td><a id='modalCancel' href="#" onclick='closeModal("matpowerModal")' style="text-align:center;font-size:10pt;">Cancel</a></td>
						<td><input type='submit' value='Import' style='min-width:45px;'/></td>
					</tr>
				</table>
			</form>
			<iframe class="hide_me" id="take_the_reload" name="take_the_reload" style="width:0px;height:0px;"></iframe>
		</div>
	</div>
	<div id="rawModal" class= 'modal'>
		<div class="modalContent" id='rawModalContent' style='width:350px;'>
			<form onsubmit='startConversion("networkNameR", "raw", 2); return false;' action="/rawImport/{{ owner }}" id='raw' enctype='multipart/form-data' method='post'>
				<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}" />
				<input type="hidden" id="networkNum" name="networkNum" value="{{ networkNum }}" />
				<input type="hidden" id="modelName" name="modelName" value="{{ modelName }}" />
				<table class='importOptions'>
				<th style="background:transparent;color:black;">RAW Conversion</th>
					<tr>
						<td>Name</td>
						<td><input type='text' id='networkNameR' name='networkNameR' required/></td>
					</tr>
					<tr>
						<td>Data File (.raw)</td>
						<td><input type='file' name='rawFile' accept = '.raw' required/></td>
					</tr>
					<tr>
						<td><a id='modalCancel' href="#" onclick='closeModal("rawModal")' style="text-align:center;font-size:10pt;">Cancel</a></td>
						<td><input type='submit' value='Import' style='min-width:45px;'/></td>
					</tr>
				</table>
			</form>
			<iframe class="hide_me" id="take_the_reload" name="take_the_reload" style="width:0px;height:0px;"></iframe>
		</div>
	</div>
	<div id='anonymizeModal' class='modal'>
		<div class='modalContent' id='anonymizeModalContent' style='width:500px'>
			<div style='font-weight:bold; font-size:14pt'>Anonymization</div>
			<br>
			<form onsubmit='anonymize();' action='/anonymizeTran/{{owner}}/{{networkName}}' id='anonymize' enctype='multipart form-data' method='post'>
				<input type='hidden' name='_csrf_token' value='{{csrf_token()}}'/>
				<input type='hidden' id='modelName' name='modelName' value='{{modelName}}'/>
				<div id='anonymizeInputs' align='left'>
					<div style='font-weight:bold; font-size:12pt'>Names and Labels:</div>
					<input type='radio' id='noChange' name='anonymizeNameOption' value='noChange' checked>
					<label for='noChange'>No Change</label>
					<br>
					<input type='radio' id='pseudonymize' name='anonymizeNameOption' value='pseudonymize'>
					<label for='pseudonymize'>Pseudonymize</label>
					<br>
					<input type='radio' id='randomize' name='anonymizeNameOption' value='randomize'>
					<label for='randomize'>Randomize</label>
					<br>
					<br>
					<div style='font-weight:bold; font-size:12pt'>Locations:</div>
					<input type='radio' id='noChange' name='anonymizeLocationOption' value='noChange' checked>
					<label for='noChange'>No Change</label>
					<br>
					<input type='radio' id='translation' name='anonymizeLocationOption' value='translation'>
					<label for='translation'>Translate <input style='width:10px' type='text' id='translateRight' name='translateRight'>[ft] to right and <input style='width:10px' type='text' id='translateUp' name='translateUp'>[ft] up and Rotate <input style='width:10px' type='text' id='rotate' name='rotate'>[degrees]</label>
					<br>
					<input type='radio' id='randomize' name='anonymizeLocationOption' value='randomize'>
					<label for='randomize'>Random (Force Layout)</label>
					<br>
					<br>
					<div style='font-weight:bold; font-size:12pt'>Electrical Properties:</div>
					<input type='checkbox' id='shuffleLoadGen' name='shuffleLoadGen' value='shuffleLoadGen'>
					<label for='shuffleLoadGen'>Shuffle loads and generators <input style='width:30px' type='text' id='shufflePerc' name='shufflePerc'>[%]</label>
					<br>
					<input type='checkbox' id='addNoise' name='addNoise' value='addNoise'>
					<label for='addNoise'>Add Noise <input style='width:30px' type='text' id='noisePerc' name='noisePerc'>[%]</label>
					<br>
					<br>
					<button onclick='event.preventDefault();closeModal("anonymizeModal")'>Cancel</button>
					<input type='submit' value='Apply' style='min-width:45px'>
				</div>
			</form>
		</div>
	</div>
	<div id='findModal' class='modal' style="display: none">
		<div class='modalContent' id='findModalContent' style='width:200px'>
			<table class='importOptions' style='padding:4px; word-wrap:break-word'>
				<tr>
					<td>Term</td>
					<td><input id='searchTerm' type='text'></td>
				</tr>
				<tr>
					<td><button style='width:75px' onclick='backButton()'>Back</button></td>
					<td id='searchHitCount' style='font-size:8pt; text-align:center'></td>
				</tr>
				<tr>
					<td><button style='width:75px' onclick='findPrevious()'>Previous</button></td>
					<td><button style='width:75px' onclick='findNext()'>Next</button></td>
				</tr>
				<tr>
					<td><button style='width:75px' onclick='closeModal("findModal")'>Cancel</button></td>
				</tr>
			</table>
		</div>
	</div>
	<div id='tableScroller'></div>
	</body>
</html>
<script type='text/javascript'>
// Globals
var unsavedChanges = false;
var lastNetworkName = "{{ networkName }}";
var previousTarget = {} // Global to keep track of previous selection target
var lastElementSelected = {}
var selection = [] // Global to keep track of multiple alt-selections
var downX, downY, upX, upY // Globals to keep track of mouse coordinates
var scaleTracker = 1
var maxBusID = -9999999;
var maxBranchID = -9999999;
var maxGenID = -9999999;
var iToSVGLookup = {}; //Necessary global to reduce runtime.  Otherwise whould have loops within loop looking through components for bus ID.
var sVGToiLookup = {}; //"  "  "  "
// Public variable to hold the current search state. TODO: put in a closure.
var searchCursor;
var currentSearchTerm;
var previousSearchTerms = [];

function makeModalsDraggable() {
	$("#findModal .modalContent").draggable()
}
makeModalsDraggable();

function saveSvg() {
	// Redirect to an .svg file that the user can save.
	alert('We are redirecting you to a static version of the SVG that you can save as a .svg file.')
	svg = document.getElementById('svgContainer').outerHTML
	b64 = btoa(svg)
	window.location = 'data:image/svg+xml;base64,\n' + b64
}

function addRectangle(x,y,width, height, id,myClass) {
	// Draw a rectangle in the SVG.
	svgOb = document.getElementsByClassName('svg-pan-zoom_viewport')[0]
	aRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect')
	aRect.setAttribute('x',x)
	aRect.setAttribute('y',y)
	aRect.setAttribute('width', width)
	aRect.setAttribute('height', height)
	aRect.setAttribute('id', id)
	aRect.setAttribute('class', myClass)
	aRect.setAttribute('stroke-width', 0.5)
	svgOb.appendChild(aRect)
}

function addCircle(x,y,r,id,myClass) {
	// Draw a circle in the SVG.
	svgOb = document.getElementsByClassName('svg-pan-zoom_viewport')[0]
	aCirc = document.createElementNS('http://www.w3.org/2000/svg', 'circle')
	aCirc.setAttribute('cx',x)
	aCirc.setAttribute('cy',y)
	aCirc.setAttribute('r',r)
	aCirc.setAttribute('id', id)
	aCirc.setAttribute('class', myClass)
	aCirc.setAttribute('stroke-width', 0.5)
	svgOb.appendChild(aCirc)
}

function addLine(x1,y1,x2,y2,id,myClass) {
	// Draw a line in the SVG.
	svgOb = document.getElementsByClassName('svg-pan-zoom_viewport')[0]
	aLine = document.createElementNS('http://www.w3.org/2000/svg', 'line')
	aLine.setAttribute('x1',x1)
	aLine.setAttribute('y1',y1)
	aLine.setAttribute('x2',x2)
	aLine.setAttribute('y2',y2)
	aLine.setAttribute('id',id)
	aLine.setAttribute('class',myClass)
	aLine.setAttribute('stroke-width', 2)
	svgOb.appendChild(aLine)
}

function buildNetwork() {
	// Find the size we need for the full chart.

	for(bus in networkData.bus) {
		iToSVGLookup[networkData.bus[String(parseInt(bus))]['bus_i']] = String(parseInt(bus))
		sVGToiLookup[String(parseInt(bus))] = networkData.bus[String(parseInt(bus))]['bus_i']
	}
	var maxLon = 100
	var maxLat = 100
	var busNumMap = {}
	for (var num in networkData.bus) {
		var busNum = networkData.bus[num]['bus_i']
		busNumMap[busNum] = num
		if (networkData.bus[num]['longitude'] > maxLon) {maxLon = networkData.bus[num]['longitude']}
		if (networkData.bus[num]['latitude'] > maxLat) {maxLat = networkData.bus[num]['latitude']}
	}
	maxLon = Math.round(maxLon + 20.0)
	maxLat = Math.round(maxLat + 20.0)
	var svgOb = document.getElementById('svgContainer')
	svgOb.setAttribute('width', maxLon)
	svgOb.setAttribute('height', maxLat)
	svgOb.setAttribute('viewBox','-10.0 -10.0 ' + maxLon + ' ' + maxLat)
	// Attach the pan/zoom behavior.
	window.panZoom = svgPanZoom('#svgContainer', {
		zoomEnabled: true,
		controlIconsEnabled: false,
		fit: true,
		center: true
	})
	// Go through and add all lines first
	for (num in networkData.branch) {
		try {
			anOb = networkData.branch[num]
			fNum = networkData.branch[num]['fbus']
			tNum = networkData.branch[num]['tbus']
			fBusNum = busNumMap[fNum]
			tBusNum = busNumMap[tNum]
			fromOb = networkData.bus[fBusNum]
			toOb = networkData.bus[tBusNum]
			if(parseInt(num)> maxBranchID) {
				maxBranchID = parseInt(num)
			}
			addLine(fromOb['longitude'],fromOb['latitude'],toOb['longitude'],toOb['latitude'],"branch_"+num,"branch" + ' p' + phaseCount(anOb))
		} catch(e) {}
	}
	// Add buses after all lines
	for (num in networkData.bus) {
		try {
			anOb = networkData.bus[num]
			if(parseInt(anOb['bus_i']) > maxBusID) {
				maxBusID = parseInt(anOb['bus_i'])
			}
			addCircle(anOb['longitude'], anOb['latitude'],5,"bus_"+num,"bus")
		} catch(e) {}
	}
	// Draw generators over busses
	for (num in networkData.gen) {
		try {
			anOb = networkData.gen[num]
			busNum = busNumMap[anOb['bus']]
			var longitude = networkData.bus[busNum]['longitude']
			var latitude = networkData.bus[busNum]['latitude']
			var width = 4
			if(parseInt(num) > maxGenID) {
				maxGenID = parseInt(num)
			}
			addRectangle(longitude-width/2,latitude-width/2,width,width,"gen_"+num,"gen")
		} catch(e) {}
	}
}

function mouseDown(event) {
	downX = event.pageX
	downY = event.pageY
}

function mouseUp(event) {
	upX = event.pageX
	upY = event.pageY
}

function clickLatLon(event) {
	// Return real lat/lon location of current click.
	var pan = window.panZoom.getPan();
	//var zoom = panZoom.getZoom();
	var sizes = window.panZoom.getSizes();
	var zoom = sizes.realZoom;
	var x, y, pt;
	var svg = document.getElementById('svgContainer');
	var pt = svg.createSVGPoint();
	pt.x = event.clientX;
	pt.y = event.clientY;
	pt = pt.matrixTransform(svg.getScreenCTM().inverse());
	x = pt.x;
	y = pt.y;
	x = (x - pan.x) / zoom;
	y = (y - pan.y) / zoom;
	return [x,y];
}

function svgClick(event) {
	// Event handler for all clicks on the SVG.
	latLon = clickLatLon(event);
	if ( (downX!==upX) || (downY!==upY) ) {
		// Immediately exit if drag is selected. SVG pan zoom handles those.
		return
	}
	if (!event.altKey) {
		// Clicking blank canvas without alt held deselcts.
		for (i=0; i<selection.length; i++) {
			selection[i].classList.remove('selected')
		}
		selection = []
	}
	event.target.classList.add('selected')
	if (event.target.id != 'svgContainer') {
		// Selecting a new object.
		var clickType = event.target.id.split("_")[0]
		var clickID = event.target.id.split("_")[1]
		lastElementSelected = event.target
		if (selection.indexOf(networkData[clickType]) === -1){
			tableDestroy()
			tableCreate(networkData[clickType][clickID])
			selection.push(event.target)
		}
	} else {
		tableDestroy()
	}
	if (selection.length >= 2) {
		// Beginning alt-selection.
		tableDestroy()
		multiSelectionTable()
	}
	previousTarget = event.target
}

function phaseCount(p) {
	total = 0
	if ("rateA" in p){
		if (parseInt(p["rateA"]) > 0){total++}
	}
	if ("rateB" in p){
		if (parseInt(p["rateB"]) > 0){total++}
	}
	if ("rateC" in p){
		if (parseInt(p["rateC"]) > 0){total++}
	}
	return total
}

function hotkeys() {
	// IE8 and earlier
	if (window.event) {
		x = event.keyCode
	}
	// IE9/Firefox/Chrome/Opera/Safari
	else if (event.which) {
		x = event.which
	}
	keychar = String.fromCharCode(x);
	if (event.target.type != 'text') {
		// Dispatch the key:
		if (keychar == '-') {
			window.panZoom.zoomOut()
		}
		else if (keychar == '=') {
			window.panZoom.zoomIn()
		}
	}
}

function tableCreate(inputObject) {
	// If object contains element_id, get the ID and type of object from the object
	if (inputObject.element_id) {
		objType = inputObject.element_id.split('_')[0]
		objId = inputObject.element_id.split('_')[1]
	} // Otherwise check what was clicked
	else {
		objType = event.target.id.split("_")[0]
		objId = event.target.id.split("_")[1]
	}
	// Draw the table for the selected object (i.e. inputObject).
	tabScroll = document.getElementById('tableScroller')
	tbl = document.createElement('table')
	// Show what type of thing you clicked
	whatSelected = document.createElement('tr')
	whatSelected.innerHTML = '<th>'+objType.charAt(0).toUpperCase()+objType.slice(1);+'</th>'
	whatSelected.innerHTML += '<th>'+String(objId)+'</th>'
	tbl.appendChild(whatSelected)
	// Put in the header.
	headRow = document.createElement('tr')
	headRow.innerHTML = '<th style="text-align: left;padding: 0px 0px 0px 11px;"><button onclick="tablePlus(this)">+</button></th>'
	if(String(objType) == "bus") {
		headRow.innerHTML += '<th><button id="moveBusButton" onclick="moveBus()">Move</button><button id="deleteButton" onclick="deleteOb()">Delete</button><button id="saveButton" onclick="tableSave(this)">Save</button></th>'
	}
	else {
		headRow.innerHTML += '<th><button id="deleteButton" onclick="deleteOb()">Delete</button><button id="saveButton" onclick="tableSave(this)">Save</button></th>'
	}
	tbl.appendChild(headRow)
	// Put the object attributes in.
	var notAllowed = ['bus_i', 'bus', 'fbus', 'tbus', 'latitude', 'longitude'] //disabled because doesn't render in real time, and on-change causes lines to sometimes render improperly.
	for (key in inputObject) {
		if (key === 'element_id') { // Don't display the element_id in the table; this is for the "find" functionality 
			continue
		}
		if (!(notAllowed.indexOf(key) > -1)) {
			row = document.createElement('tr')
			row.innerHTML = '<td><button onclick="tableDel(this)">&#215;</button><input style="width:112px" value=' + key + '></input></td>'
			row.innerHTML += '<td><input value="' + inputObject[key] + '"></input></td>'
			tbl.appendChild(row)
		}
	}
	tabScroll.appendChild(tbl)
}

function tableDel(me) {
	// Button in selection table that deletes attribute rows.
	myRow = me.parentElement.parentElement
	myTable = myRow.parentElement
	myTable.removeChild(myRow)
}

function tablePlus(me) {
	// Button in selection table that adds attribute rows.
	myTable = me.parentElement.parentElement.parentElement
	newRow = myTable.insertRow(2)
	newRow.innerHTML = '<td><button onclick="tableDel(this)">&#215;</button><input style="width:112px"></input></td>'
	newRow.innerHTML += '<td><input></input></td>'
}

function tableSave(me) {
	// Button that saves changes made in selection table.
	var tbl = me.parentElement.parentElement.parentElement
	var toJson = {}
	// convert HTML table to JSON
	for (var i = 1; i < tbl.rows.length; i++) {
		var key = tbl.rows[i].cells[0].lastElementChild.value
		if (key !== '') {
			toJson[key] = tbl.rows[i].cells[1].lastElementChild.value
		}
	}
	// Update tree with new values
	var clickType = previousTarget.id.split("_")[0]
	var clickID = previousTarget.id.split("_")[1]
	for (key in toJson) {
		networkData[clickType][clickID][key] = toJson[key]
	}
	// Delete properties from tree
	for (key in networkData[clickType][clickID]) {
		// HACK: DON'T DELETE DATA THAT OBJECTS MUST CONTAIN VIA CHECKING THE NAMES.
		if (!toJson.hasOwnProperty(key) && key!='latitude' && key!='longitude' && key!='bus_i' && key!='fbus' && key!='tbus' && key!='bus') {
			delete networkData[clickType][clickID][key]
		}
	}
	unsavedChanges = true;
	alert('Updated object: ' + previousTarget.id)
	tableDestroy()
}

function tableDestroy() {
	// Remove the selection table.
	tabScroll = document.getElementById('tableScroller')
	kid = tabScroll.children[0]
	if (!(kid === undefined)) {tabScroll.removeChild(kid)}
}

function deleteOb() {
	// Delete button in selection table.
	var clickType = previousTarget.id.split("_")[0]
	var clickID = previousTarget.id.split("_")[1]

	// Delete Lines
	if (clickType === 'branch') {
		previousTarget.remove()
		delete networkData[clickType][clickID]
	}
	// Delete Squares
	if (clickType === 'gen') {
		previousTarget.remove()
		delete networkData[clickType][clickID]
	}
	// Delete Circles
	if (clickType === 'bus') {
		gens = 0
		for(gen in networkData.gen) {
			if (parseInt(networkData.gen[String(gen)]['bus']) === parseInt(clickID)) {
				gens++
			}
		}
		// Check for connected lines
		lines = 0
		for(branch in networkData.branch) {
			if ( (parseInt(networkData.branch[String(branch)]['fbus']) === parseInt(clickID))
				|| (parseInt(networkData.branch[String(branch)]['tbus']) === parseInt(clickID)) ) {
				lines++
			}
		}
		if (lines > 0 || gens > 0) {
			alert('Cannot delete circles with components still connected')
		}
		else {
			previousTarget.remove()
			delete networkData[clickType][clickID]
		}
	}
	unsavedChanges=true
	tableDestroy()
}

function scaleTo() {
	// Change the relative thickness of all lines and circles. Helps users see detail in big models.
	if(scaleTracker == 1)  {
		x = parseFloat(prompt("Scale line thickness by this multiple:","1.0"))
		if (!x) {
			return
		}
		scaleTracker = x;
	}
	else {
		scaleTracker = 1
		x = scaleTracker
		x = parseFloat(prompt("Scale line thickness by this multiple:","1.0"))
		if (!x) {
			return
		}
		scaleTracker = x;
	}
	circles = document.getElementsByTagName('circle')
	lines = document.getElementsByTagName('line')
	rects = document.getElementsByTagName('rect')
	// Scale Circles
	for (i = 0; i < circles.length; i++) {
		circles[i].setAttribute('r', 5*x)
		circles[i].setAttribute('stroke-width', 0.5*x)
	}
	// Scale Lines
	for (i = 0; i < lines.length; i++) {
		if (lines[i].getAttribute('class').indexOf('p2') !== -1) {
			lines[i].setAttribute('stroke-width', 2*x)
		}
		else if (lines[i].getAttribute('class').indexOf('p3') !== -1) {
			lines[i].setAttribute('stroke-width', 3*x)
		}
		else if (lines[i].getAttribute('class').indexOf('parentChild') !== -1) {
			lines[i].setAttribute('stroke-width', 0.5*x)
		}
		else {
			lines[i].setAttribute('stroke-width', x)
		}
	}
	//Scale Rects    
	for(i = 0; i < rects.length; i++) {
		xPos = parseFloat(rects[i].getAttribute('x'))
		yPos = parseFloat(rects[i].getAttribute('y'))
		width = parseFloat(rects[i].getAttribute('width'))
		height = parseFloat(rects[i].getAttribute('height'))
		strokeW = parseFloat(rects[i].getAttribute('stroke-width'))
		longitude = xPos + width/2
		latitude = yPos + height/2
		rects[i].setAttribute('width', 4*x)
		rects[i].setAttribute('height', 4*x)
		rects[i].setAttribute('stroke-width', x*0.5)
		rects[i].setAttribute('x', longitude - (2*x))
		rects[i].setAttribute('y', latitude - (2*x))
	}   
}

function multiSelectionTable() {
	// Build the table for multiple selections.
	tabScroll = document.getElementById('tableScroller')
	tbl = document.createElement('table')
	// Put in the header.
	headRow = document.createElement('tr')
	headRow.innerHTML = '<th>Selected Elements</th>'
	tbl.appendChild(headRow)
	currentSel = selection[selection.length - 1].id
	// If user was alt+clicking a selected thing, deselect it.
	for (i = 0; i < selection.length; i++) {
		if(selection[i].id == currentSel  && i != selection.length-1) {
			selection[i].classList.remove('selected')
			selection.splice(i, 1)
			selection.splice(selection.length - 1, 1)
			continue
		}
	}
	// Put the object in.
	for (i = 0; i < selection.length; i++) {
		row = document.createElement('tr')
		row.innerHTML = '<td>' + selection[i].id + '</td>'
		tbl.appendChild(row)
	}
	tabScroll.appendChild(tbl)
	// Remove header if we have deselected the last item.
	if (selection.length == 0) {
		tableDestroy()
	}
}

function newNode(typeOfNode) {
	// Create a new node object.
	maxBusID = maxBusID + 1 // This maxBusID is the ID of the new bus.
	iToSVGLookup[String(maxBusID)] = String(maxBusID)
	sVGToiLookup[String(maxBusID)] = String(maxBusID)
	// Add handler to get user's click location for adding.
	document.getElementById('svgContainer').addEventListener('click', newNodeListener, false)
	document.body.style.cursor = 'crosshair'
}

function newNodeListener() {
	// Helper function that finishes node creation after user clicks on a location.
	// NB. maxBusID is the ID of the new bus.
	var newBusGenObj = {
		longitude: "0",
		latitude: "0",
		bus_i: String(maxBusID),
		type: "3",
		Pd: "0",
		Qd: "0",
		Gs: "0",
		Bs: "0",
		area: "1",
		Vm: "1",
		Va: "0",
		baseKV: "135",
		zone: "1",
		Vmax: "1.05",
		Vmin: "0.95",
	}
	var xloc = event.pageX
	var yloc = event.pageY
	coords = clickLatLon(event)
	xloc = coords[0]
	yloc = coords[1]
	var newType = "bus"
	// Save to tree
	networkData[newType][String(maxBusID)] = newBusGenObj
	networkData[newType][String(maxBusID)].longitude = xloc
	networkData[newType][String(maxBusID)].latitude = yloc
	// Draw on svg
	x = networkData[newType][String(maxBusID)].longitude
	y = networkData[newType][String(maxBusID)].latitude
	r = 5
	addCircle(x,y,r,newType+"_"+String(maxBusID),newType)
	if(scaleTracker != 1.0) {
		newCir = document.getElementById(newType+"_"+String(maxBusID))
		newCir.setAttribute('r', 5*scaleTracker)
		newCir.setAttribute('stroke-width', 0.5*scaleTracker)
	}
	this.removeEventListener('click', newNodeListener, false)
	document.body.style.cursor = 'auto'
}

function moveBus() {
	// Start the bus moving process by adding a listener
	document.getElementById('svgContainer').addEventListener('click', moveBusListener, false)
	document.body.style.cursor = 'crosshair'
}

function moveBusListener() {
	// Helper to complete bus movement after user clicks new location.
	currSel = lastElementSelected
	selectionIDSplit = currSel.id.split("_")
	selBusID = parseInt(selectionIDSplit[1])
	selBus = networkData["bus"][String(selBusID)]
	selBus_i_ID = selBus["bus_i"]
	coords = clickLatLon(event)
	selBus.longitude = coords[0]
	selBus.latitude = coords[1]
	for (num in networkData.branch) {
		selBranch = networkData.branch[String(parseInt(num))]
		fBusID = selBranch['fbus']
		tBusID= selBranch['tbus']
		if(fBusID == selBus_i_ID || tBusID == selBus_i_ID) {
			// Redraw connected lines containing selected bus
			document.getElementById("branch_" + String(parseInt(num))).remove()  
			fromBus = networkData.bus[fBusID]
			toBus = networkData.bus[tBusID]
			var fromBus = networkData.bus[iToSVGLookup[fBusID]]
			var toBus = networkData.bus[iToSVGLookup[tBusID]]
			x1 = fromBus['longitude']
			y1 = fromBus['latitude']
			x2 = toBus['longitude']
			y2 = toBus['latitude']
			addLine(x1,y1,x2,y2,"branch_"+String(parseInt(num)),"branch" + ' p' + phaseCount(selBranch))
			if(scaleTracker != 1.0) {
				newLine = document.getElementById("branch_" + String(parseInt(num)))
				newLine.setAttribute('stroke-width', 3*scaleTracker)
			}
			// Redraw adjacent buses
			r = 5
			if(fBusID == selBus_i_ID) {
				document.getElementById('bus_' + iToSVGLookup[tBusID]).remove()
				addCircle(x2,y2,r,"bus_"+String(iToSVGLookup[tBusID]),"bus")
				if(scaleTracker != 1.0) {
					newCir = document.getElementById("bus_"+String(iToSVGLookup[tBusID]))
					newCir.setAttribute('r', 5*scaleTracker)
					newCir.setAttribute('stroke-width', 0.5*scaleTracker)
				}
			}
			if(tBusID == selBus_i_ID) {
				document.getElementById('bus_' + iToSVGLookup[fBusID]).remove()
				addCircle(x1,y1,r,"bus_"+String(iToSVGLookup[fBusID]),"bus")
				if(scaleTracker != 1.0) {
					newCir = document.getElementById("bus_"+String(iToSVGLookup[fBusID]))
					newCir.setAttribute('r', 5*scaleTracker)
					newCir.setAttribute('stroke-width', 0.5*scaleTracker)  
				}     
			}
			//Redraw generators on adjacent buses
			for(gen in networkData.gen) {
				busGenID = networkData.gen[String(parseInt(gen))]['bus']
				if(busGenID == fBusID) {
					document.getElementById("gen_" + String(parseInt(gen))).remove() 
					addRectangle(x1 - 4/2, y1 - 4/2, 4, 4, "gen_" + String(parseInt(gen)), "gen")
					if(scaleTracker != 1.0) {
						newRect = document.getElementById("gen_"+String(parseInt(gen)))
						xPos = parseFloat(newRect.getAttribute('x'))
						yPos = parseFloat(newRect.getAttribute('y'))
						width = parseFloat(newRect.getAttribute('width'))
						height = parseFloat(newRect.getAttribute('height'))
						strokeW = parseFloat(newRect.getAttribute('stroke-width'))
						longitude = xPos + width/2
						latitude = yPos + height/2
						newRect.setAttribute('width', 4*scaleTracker)
						newRect.setAttribute('height', 4*scaleTracker)
						newRect.setAttribute('stroke-width', scaleTracker*0.5)
						newRect.setAttribute('x', longitude - (2*scaleTracker))
						newRect.setAttribute('y', latitude - (2*scaleTracker))
					}
				}
				if(busGenID == tBusID) {
					document.getElementById("gen_" + String(parseInt(gen))).remove() 
					addRectangle(x2- 4/2, y2 - 4/2, 4, 4, "gen_" + String(parseInt(gen)), "gen")
					if(scaleTracker != 1.0) {
						newRect = document.getElementById("gen_"+String(parseInt(gen)))
						xPos = parseFloat(newRect.getAttribute('x'))
						yPos = parseFloat(newRect.getAttribute('y'))
						width = parseFloat(newRect.getAttribute('width'))
						height = parseFloat(newRect.getAttribute('height'))
						strokeW = parseFloat(newRect.getAttribute('stroke-width'))
						longitude = xPos + width/2
						latitude = yPos + height/2
						newRect.setAttribute('width', 4*scaleTracker)
						newRect.setAttribute('height', 4*scaleTracker)
						newRect.setAttribute('stroke-width', scaleTracker*0.5)
						newRect.setAttribute('x', longitude - (2*scaleTracker))
						newRect.setAttribute('y', latitude - (2*scaleTracker))
					}
				}
			}
		}
	}

	//Redraw selected bus
	document.getElementById('bus_' + selBusID).remove() 
	addCircle(coords[0],coords[1],5,"bus_"+String(selBusID),"bus")  
	if(scaleTracker != 1.0) {
		newCir = document.getElementById("bus_"+String(selBusID))
		newCir.setAttribute('r', 5*scaleTracker)
		newCir.setAttribute('stroke-width', 0.5*scaleTracker)
	}
	//Redraw generator on selected bus
	for(gen in networkData.gen) {
		busGenID = networkData.gen[String(parseInt(gen))]['bus']
		if(busGenID == selBus_i_ID) {
			document.getElementById("gen_" + String(parseInt(gen))).remove() 
			addRectangle(coords[0] - 4/2, coords[1] - 4/2, 4, 4, "gen_" + String(parseInt(gen)), "gen")
			if(scaleTracker != 1.0) {
				newRect = document.getElementById("gen_"+String(parseInt(gen)))
				xPos = parseFloat(newRect.getAttribute('x'))
				yPos = parseFloat(newRect.getAttribute('y'))
				width = parseFloat(newRect.getAttribute('width'))
				height = parseFloat(newRect.getAttribute('height'))
				strokeW = parseFloat(newRect.getAttribute('stroke-width'))
				longitude = xPos + width/2
				latitude = yPos + height/2
				newRect.setAttribute('width', 4*scaleTracker)
				newRect.setAttribute('height', 4*scaleTracker)
				newRect.setAttribute('stroke-width', scaleTracker*0.5)
				newRect.setAttribute('x', longitude - (2*scaleTracker))
				newRect.setAttribute('y', latitude - (2*scaleTracker))
			}
		}
	}
	this.removeEventListener('click', moveBusListener, false)
	document.body.style.cursor = 'auto'
}

function newGen() {
	// Create new generator.
	currSel = selection[0]
	selectionIDSplit = currSel.id.split("_")
	if(selection.length === 1 && String(selectionIDSplit[0]) == "bus") {
		var newGenID = (Object.keys(networkData["gen"]).length)+1
		newGenObj = {}
		selBusID = parseInt(selectionIDSplit[1])
		selBus = networkData["bus"][String(selBusID)]
		var newGenObj = {}
		newGenObj = {
			longitude: selBus.longitude,
			latitude: selBus.latitude,
			bus: String(sVGToiLookup[selBusID]),
			Pg: "23.54",
			Qg: "0",
			Qmax: "150",
			Qmin: "-20",
			Vg: "1",
			mBase: "100",
			status: "1",
			Pmax: "80",
			Pmin: "0",
			Pc1: "0",
			Pc2: "0",
			Qc1min: "0",
			Qc1max: "0",
			Qc2min: "0",
			Qc2max: "0",
			ramp_agc: "0",
			ramp_10: "0",
			ramp_30: "0",
			ramp_q: "0",
			apf: "0",
		}
		addRectangle(selBus.longitude - 4/2, selBus.latitude - 4/2, 4, 4, "gen_" + newGenID, "gen")
		if(scaleTracker != 1.0) {
			newRect = document.getElementById("gen_"+newGenID)
			xPos = parseFloat(newRect.getAttribute('x'))
			yPos = parseFloat(newRect.getAttribute('y'))
			width = parseFloat(newRect.getAttribute('width'))
			height = parseFloat(newRect.getAttribute('height'))
			strokeW = parseFloat(newRect.getAttribute('stroke-width'))
			longitude = xPos + width/2
			latitude = yPos + height/2
			newRect.setAttribute('width', width*scaleTracker/2)
			newRect.setAttribute('height', height*scaleTracker/2)
			newRect.setAttribute('stroke-width', strokeW*scaleTracker*0.5)
			newRect.setAttribute('x', longitude - (width*scaleTracker/4))
			newRect.setAttribute('y', latitude - (height*scaleTracker/4))
		}
		networkData["gen"][String(newGenID)] = newGenObj
	}
}

function newLink() {
	// Add a branch.
	busOne = selection[0].id.split("_")
	busTwo = selection[1].id.split("_")
	if (selection.length === 2 && String(busOne[0]) == "bus" && String(busTwo[0]) == "bus") {
		maxBranchID = String(parseInt(maxBranchID) + 1)
		var newCompID = maxBranchID
		var fBusID = parseInt(busOne[1])
		var tBusID = parseInt(busTwo[1])
		var newLink = {}
		newLink = {
			r: "0.02",
			x: "0.06",
			b: "0.03",
			rateA: "130",
			rateB: "130",
			rateC: "130",
			ratio: "0",
			angle: "0",
			status: "1",
			angmin: "-360.0",
			angmax: "360.0",
			fbus: String(sVGToiLookup[fBusID]),
			tbus: String(sVGToiLookup[tBusID]),
		}
		// Save to tree
		networkData.branch[String(newCompID)] = newLink
		// Draw on svg
		x1 = networkData.bus[String(fBusID)].longitude
		y1 = networkData.bus[String(fBusID)].latitude
		x2 = networkData.bus[String(tBusID)].longitude
		y2 = networkData.bus[String(tBusID)].latitude
		addLine(x1,y1,x2,y2,"branch_" + String(newCompID),"branch" + ' p' + phaseCount(newLink))
		if(scaleTracker != 1.0) {
			newLine = document.getElementById("branch_" + String(newCompID))
			newLine.setAttribute('stroke-width', 3*scaleTracker)
		}
		//Redraw connected components
		r = 5
		document.getElementById('bus_' + fBusID).remove()
		document.getElementById('bus_' + tBusID).remove()
		addCircle(x1,y1,r,"bus_"+String(fBusID),"bus")
		addCircle(x2,y2,r,"bus_"+String(tBusID),"bus")
		if(scaleTracker != 1.0) {
			newCir1 = document.getElementById("bus_"+String(fBusID))
			newCir1.setAttribute('r', 5*scaleTracker)
			newCir1.setAttribute('stroke-width', 0.5*scaleTracker)
			newCir2 = document.getElementById("bus_"+String(tBusID))
			newCir2.setAttribute('r', 5*scaleTracker)
			newCir2.setAttribute('stroke-width', 0.5*scaleTracker)
		}
		for(gen in networkData.gen) {
			// Check for connected buses and generators, redraw them to make sure they stay on top.
			busGenID = networkData.gen[String(parseInt(gen))]['bus']
			if(busGenID == sVGToiLookup[fBusID]) {
				document.getElementById("gen_" + String(parseInt(gen))).remove() 
				addRectangle(x1 - 4/2, y1 - 4/2, 4, 4, "gen_" + String(parseInt(gen)), "gen")
				if(scaleTracker != 1.0) {
					newRect = document.getElementById("gen_"+String(parseInt(gen)))
					xPos = parseFloat(newRect.getAttribute('x'))
					yPos = parseFloat(newRect.getAttribute('y'))
					width = parseFloat(newRect.getAttribute('width'))
					height = parseFloat(newRect.getAttribute('height'))
					strokeW = parseFloat(newRect.getAttribute('stroke-width'))
					longitude = xPos + width/2
					latitude = yPos + height/2
					newRect.setAttribute('width', 4*scaleTracker)
					newRect.setAttribute('height', 4*scaleTracker)
					newRect.setAttribute('stroke-width', scaleTracker*0.5)
					newRect.setAttribute('x', longitude - (2*scaleTracker))
					newRect.setAttribute('y', latitude - (2*scaleTracker))
				}
			}
			if(busGenID == sVGToiLookup[tBusID]) {
				document.getElementById("gen_" + String(parseInt(gen))).remove() 
				addRectangle(x2- 4/2, y2 - 4/2, 4, 4, "gen_" + String(parseInt(gen)), "gen")
				if(scaleTracker != 1.0) {
					newRect = document.getElementById("gen_"+String(parseInt(gen)))
					xPos = parseFloat(newRect.getAttribute('x'))
					yPos = parseFloat(newRect.getAttribute('y'))
					width = parseFloat(newRect.getAttribute('width'))
					height = parseFloat(newRect.getAttribute('height'))
					strokeW = parseFloat(newRect.getAttribute('stroke-width'))
					longitude = xPos + width/2
					latitude = yPos + height/2
					newRect.setAttribute('width', 4*scaleTracker)
					newRect.setAttribute('height', 4*scaleTracker)
					newRect.setAttribute('stroke-width', scaleTracker*0.5)
					newRect.setAttribute('x', longitude - (2*scaleTracker))
					newRect.setAttribute('y', latitude - (2*scaleTracker))
				}
			}
		}
	}
}


function showModal(element){
	// Show a modal dialog.
	gebi(element).style.display = 'block'
}

function closeModal(element){
	// Hide a modal dialog.
	gebi(element).style.display = 'none'
}

function showProgressDialog(progressType, dialogMessage, cancelType) {
	// Show a progress dialog for loading, converting, etc.
	background = document.createElement('div')
	background.id = 'progressBackground'
	background.style.zIndex = '9998'
	progContent = document.createElement('div')
	progContent.id = 'progressContent'
	progContent.style.zIndex = '9999'
	progressText = document.createElement('h2')
	progressText.id = 'progressText'
	progressText.textContent = dialogMessage
	document.body.appendChild(background)
	document.body.appendChild(progContent)
	// If progressType type is spinner create and show the spinner
	if (progressType == 'spinner'){
		spinner = document.createElement('img')
		spinner.src = '/static/spinner.gif'
		progContent.appendChild(spinner)
		progContent.appendChild(progressText)
		var cancelBtn = document.createElement("BUTTON");
		var t = document.createTextNode("cancel");
		cancelBtn.style.marginTop = '5px';
		cancelBtn.style.background= 'crimson'
		cancelBtn.appendChild(t);
		progContent.appendChild(cancelBtn);
	}
	// If cancelType is not none, add an onclick even to the cancel button to cancel the conversion
	if (cancelType != 'none'){
		cancelType = (typeof cancelType === 'undefined') ? 'no' : cancelType;
		cancelBtn.onclick = function() {
			if (cancelType == 'conversion'){
				if (confirm('Are you sure you want to cancel the conversion?')) {
					newnetwork.submit();
				}
			}
			else if(cancelType == 'none'){
				cancelBtn.style.display = 'none'
			}
			else
			{
				// stop rendering feeder, show file menu, etc.y
				removeProgressDialog()
			}
		};
	}
}

function removeProgressDialog() {
	// Remove the progress dialog.
	if (gebi('progressBackground')!=null)
		document.body.removeChild(gebi('progressBackground'))
	if (gebi('progressContent')!=null)
		document.body.removeChild(gebi('progressContent'))
}

function loading() {
	// Load everything in when the page is loaded.
	showProgressDialog('spinner','Loading Network', 'loading');
	// Helper function to do the stuff that takes a long time:
	function longLoadingProcess() {
		var modelName = '{{modelName}}'
		// Check conversion.
		$.ajax({
			url: "/checkConversion/" + modelName + "/" + "{{ owner }}"
		}).done(function (data) {
			if (data.exists == true) {
				showProgressDialog('spinner','Converting network','conversion');
				checkConversion()
			}
		})
		// Send network name to model and remove loading dialog.
		try {
			window.opener.$(window.opener.document).trigger('mainWindow', "{{ modelName }};"+"networkName{{networkNum}};"+lastNetworkName);
		} catch (err) {} // Opened directly with no previous window.
		// Finally, draw the network:
		buildNetwork();
		removeProgressDialog();
	}
	setTimeout(longLoadingProcess, 100)
}

async function startConversion(elementName, formId, nextAction) {
	// Additional check, required for Safari browsers
	var newName = document.getElementById(elementName).value;
	let submitForm = false;
	// Check if the file exists, using the user-provided name
	if (true) {
		var modelName = '{{ modelName }}'
		await $.ajax({
			url: '/uniqObjName/Network/' + '{{ owner }}' + '/' + newName + '/' + modelName
		}).done(function (data) {
			if (data.exists) {
				alert('You already have a Network named "' + newName + '", please choose a different name.')
			} else {
				// The filename does not already exist. Submit the form with the matpower file
				if (nextAction == 1)	// 1 for blank network modal
					newnetwork.submit()
				else					// 2 for matpower and raw modal
					submitForm = true;
			}
		})
	}
	if (!submitForm) return;

	// Do the conversion (matpower/raw import)
	showProgressDialog('spinner', 'Converting network', 'conversion');
	const form = document.getElementById(formId);
    const formData = new FormData(form);
	const formRequest = $.ajax({
        type: 'POST',
        url: form.action,
        data: formData,
        processData: false,
        contentType: false,
	});
	// Check for when the conversion is done
	formRequest.done(function(data) {
		checkConversion();
	});
}

function checkConversion() {
	// Periodically check to see if any conversion is happening. And if it's done, load the converted model.
	var conversionStatus = 'converting';
	// Check every 5 seconds for a feeder & refresh.
	var intervalId = window.setInterval(function pingAPI(){
		var modelName = '{{ modelName }}'
		$.ajax({
			url: '/checkConversion/' + modelName + '/' + '{{ owner }}'
		}).done(function (data) {

			// Set conversion status depending on result of AJAX request
			if (data.exists == null)
				conversionStatus = data;
			else if (data.exists)
				conversionStatus = 'converting'
			else if (!data.exists)
				conversionStatus = 'done';

			// Deal with the conversion status
			if (conversionStatus == 'done') {
				window.clearInterval(intervalId);
				alert('Conversion complete.')
				window.location.reload();
			}
			else if (conversionStatus == 'matError') {
				window.clearInterval(intervalId);
				alert('The .m file does not contain any valid data.')
				removeProgressDialog();
			}
			else if (conversionStatus == 'rawError') {
				window.clearInterval(intervalId);
				alert('The .raw file does not contain any valid data.')
				removeProgressDialog();
			}
			else if (conversionStatus == 'octaveError') {
				window.clearInterval(intervalId);
				alert('Matpower/Octave setup is incorrect; please contact your system administrator.')
				removeProgressDialog();
			}
		})
		return pingAPI;
	}, 5000);
}

function saveNetwork() {
	// Start save process on user command.
	gebi("fileOps").click();
	savePoster("{{ networkName }}", "{{ modelName }}", "{{ owner }}")
	alert("Network saved to disk.")
}

function savePoster(name, modelName, user) {
	// Do activity to save network over the web.
	networkObject = {
		mpcVersion: networkData.mpcVersion,
		baseMVA: networkData.baseMVA,
		bus: networkData.bus,
		gen: networkData.gen,
		branch: networkData.branch,
	}
	payload = {
		'name': name,
		'networkObjectJson': JSON.stringify(networkObject),
		"_csrf_token": "{{ csrf_token() }}",
		ref: "{{ ref }}"
	}
	unsavedChanges=false
	post_to_url("/saveNetwork/" + user + "/" + modelName + "/" + name, payload)
}

function renameNetwork() {
	// Rename the network with web server.
	if (unsavedChanges){
		alert('You have unsaved changes. Please save the network before proceeding.')
	}
	else{
		var newName = prompt("Rename the network to",lastNetworkName)
		while (! /^[\w\s]+$/.test(newName) || /^\s+$/.test(newName)){
			newName = prompt("Only letters, digits and underscore are allowed.\nPlease enter a different name", "{{ networkName }}")
		}
		if (newName){
			checkNetworkName(newName)
		}
	}
}

function checkNetworkName(newName) {
	// Check to make sure network name is unique.
	if (true) {
		var modelName = "{{ modelName }}"
		$.ajax({
			url: "/uniqObjName/Network/" + "{{ owner }}" + "/" + newName + "/" + modelName
		}).done(function (data) {
			if (data.exists) {
				alert("You already have a Network named '" + newName + "', please choose a different name.")
				renameNetwork()
			}
			else{
				gebi("fileOps").click();
				post_to_url("/renameNetwork/" + "{{ owner }}" + "/" + "{{ modelName }}" + "/" + lastNetworkName + "/" + newName + "/" + "{{ networkNum }}")
				document.getElementById('networkName').innerHTML = newName;
				lastNetworkName = newName; //permits multiple name changes without forcing page refresh.
				// Send updated name to model.
				window.opener.$(window.opener.document).trigger('mainWindow', "{{ modelName }};"+"networkName{{networkNum}};"+lastNetworkName);
				clickCloseEvent("File","fileOps")
			}
		})
	}
}

function startProcess(startUrl) {
	// Start a long running process using startUrl.
	$.ajax({
		url: startUrl
	}).done(function (data) {})
}

function startCheck(checkUrl) {
	// Do get requests to checkUrl for long running process monitoring.
	window.setInterval(function checkAPI() {
		$.ajax({
			url: checkUrl
		}).done(function (data) {
			if (data.exists == true) {
				// Still processing.
			} else if (data.exists == false) {
				// Success processing.
				removeProgressDialog()
				window.location.reload();
			} else {
				// Error processing.
				alert(data)
				removeProgressDialog()
				window.location.reload();
			}
		})
	}, 5000)
}

function anonymize() {
	// Start anonymization function.
	showProgressDialog('spinner', 'Anonymizing Network')
	startProcess('/anonymizeTrans/{{owner}}/{{networkName}}')
	startCheck('/checkAnonymizeTran/{{owner}}/{{modelName}}')
}

// *********************************************
// *********** FIND MODAL FUNCTIONS ************
// *********************************************

/**
 * Find elements containing data matching the input string. 
 * Iterate through every element in the network to find all matching elements.
 * @param  {string} inputString
 * @return {Object[]} results
 */
 function findElementsViaString(inputString) {
	results = []
	for (branchIndex in networkData.branch) {
		branch = networkData.branch[branchIndex]
		subIndex = JSON.stringify(branch).indexOf(inputString)
		if (subIndex != -1) {
			branch.element_id = 'branch_' + branchIndex
			results.push(branch)
		}
	}
	for (busIndex in networkData.bus) {
		bus = networkData.bus[busIndex]
		subIndex = JSON.stringify(bus).indexOf(inputString)
		if (subIndex != -1) {
			bus.element_id = 'bus_' + busIndex
			results.push(bus)
		}
	}
	for (genIndex in networkData.gen) {
		gen = networkData.gen[genIndex]
		subIndex = JSON.stringify(gen).indexOf(inputString)
		if (subIndex != -1) {
			gen.element_id = 'gen_' + genIndex
			results.push(gen)
		}
	}
	return results
}

/**
 * Handler function of the "Back" button in the "Find" modal. 
 * Find the previous string input.
 */
function backButton() {
	if (previousSearchTerms.length == 0) {
		console.log("There is no previous search term")
		return
	}
	currentSearchTerm = previousSearchTerms.pop()
	$("#searchTerm").val(currentSearchTerm)
	findNext()
}

/**
 * Handler function of the "Next" button in the "Find" modal.
 * If objects are found, zoom to the first object in the list.
 */
function findNext() {

	term = gebi('searchTerm').value
	if (term.length == 0) {
		return false
	}
	if (currentSearchTerm != term) {
		if (currentSearchTerm != undefined) {
			previousSearchTerms.push(currentSearchTerm)
		}
		currentSearchTerm = term
		searchCursor = undefined
	}

	hits = findElementsViaString(term)
	gebi('searchHitCount').innerHTML = hits.length + ' Hits'
	try {
		if (hits.length == 0) {
			return false
		}
		clearAllSelected()
		tableDestroy()
		if (searchCursor == undefined) {
			searchCursor = 0
		} else {
			searchCursor++
			if (searchCursor == hits.length) {
				searchCursor = 0
			}
			if (searchCursor == -1) { // "Previous" hit after 0
				searchCursor = hits.length - 1
			}
		}
		hit = hits[searchCursor]
		tableCreate(hit)
		element = document.getElementById(hit.element_id)
		element.classList.add('selected')
		selection.push(element)
		zoomToSelection()
		removeElementIds(hits)
	} catch (err) {
		alert('The following error was encountered:\n' + err.message)
	}
}

/**
 * Handler function of the "Previous" botton in the "Find" modal.
 * Find the previous object in a matched list.
 */
function findPrevious() {
	if (searchCursor == undefined) {
		findNext()
	} else {
		searchCursor -= 2
		findNext()
	}
}

/**
 * Zoom to selected element in the center of current window.
 */
 function zoomToSelection() {
	domTargets = document.getElementsByClassName('selected')
	if (domTargets.length != 1) {
		return false
	}
	element = domTargets[0]
	if (element.id.includes('bus')) {
		x = element.cx.baseVal.value
		y = element.cy.baseVal.value
	}
	else if (element.id.includes('gen')) {
		x = element.x.baseVal.value
		y = element.y.baseVal.value
	}
	else if (element.id.includes('branch')) {
		x = (element.x1.baseVal.value + element.x2.baseVal.value) / 2
		y = (element.y1.baseVal.value + element.y2.baseVal.value) / 2
	}
	panZoom.pan({x: 0, y: 0})
	var realZoom = window.panZoom.getSizes().realZoom;
	var newX = -x * realZoom + window.panZoom.getSizes().width / 2
	var newY = -y * realZoom + window.panZoom.getSizes().height / 2
	panZoom.pan({x: newX, y: newY})

	objectCount = Object.keys(networkData.bus).length + Object.keys(networkData.gen).length + Object.keys(networkData.branch).length
	if (objectCount < 100) {
		panZoom.zoom(2)
	} else {
		panZoom.zoom(objectCount / 50)
	}
}

/**
 * Clear all selected elements.
 */
function clearAllSelected() {
	for (i = 0; i < selection.length; i++) {
			selection[i].classList.remove('selected')
	}
	selection = []
}

/**
 * Remove element_id field from elements in list.
 */
function removeElementIds(elements) {
	for (i = 0; i < elements.length; i++) {
		delete elements[i].element_id
	}
}

function downloadTextFile(fileName, text) {
	// Insert the model as text and push it as a download.
	console.log(text)
	var element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    element.setAttribute('download', fileName);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}

{% if is_admin or not public %}
// Add prompt to save changes before exit.
window.onbeforeunload = function(e) {
	var confirmationMessage = 'It looks like you have been editing something. ';
	confirmationMessage += 'If you leave before saving, your changes will be lost.';
	if (unsavedChanges) return confirmationMessage;
};
{% endif %}
</script>